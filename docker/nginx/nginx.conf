load_module modules/ngx_http_image_filter_module.so;
load_module modules/ngx_http_cache_purge_module.so;

worker_processes  4;

events {
  worker_connections  1024;
}

http {
  
  error_log  off;
  access_log off;
  
log_format main '$http_x_forwarded_for - $remote_user [$time_local] '
'"$request_method $scheme://$host$request_uri $server_protocol" '
'$status $body_bytes_sent "$http_referer" '
'"$http_user_agent" $request_time';
  

proxy_cache_path /var/cache/nginx/img levels=1:2 keys_zone=img:100m inactive=7d  max_size=1g use_temp_path=off;
proxy_cache_key $uri$is_args$args;
  
  #front
server {

	server_name   astronews.ror.ru;
    listen 80;

	sendfile        on;
    #tcp_nopush     on;
    proxy_read_timeout 5;
    proxy_connect_timeout 5;
    proxy_send_timeout 5;
    send_timeout 5;
    keepalive_timeout  5;
	
    gzip on;
	gzip_proxied any;
	gzip_comp_level 9;
	gzip_buffers 16 8k;
	gzip_http_version 1.1;
	gzip_types text/plain text/css application/json 
	applicationx-javascript text/xml application/xml 
	application/xml+rss text/javascript;
	

 location ~ /purge(/.*) {
    proxy_cache_purge img $1$is_args$args;
  }

 location /test/ {
     add_header Content-Type text/html;
     return 200 '<html><body>Test</body></html>';
  }

	location /wp-content/uploads/ {
	   location ~* ^.+\.(jpeg|jpg|png|webp){
		proxy_cache img;
		proxy_cache_valid 200 2d;
		proxy_pass             http://127.0.0.1:9003;
                proxy_buffering        on;
                proxy_cache_use_stale  error timeout invalid_header updating
                http_500 http_502 http_503 http_504; 
		etag on;
		if_modified_since exact;
                expires 1y;
		add_header Pragma public;
   		add_header Cache-Control "public";
            }

	}



	location / {
		 
		proxy_redirect off;
		proxy_set_header Host $host;
#		proxy_set_header Host $host:$server_port; # <-- this one solved mine
		proxy_set_header X-Forwarded-Host $http_host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_pass http://web-app:4000;

    }
}


server {
    listen 9003;
    allow 127.0.0.1;
    deny all;
    #limit_req zone=2persec burst=10;


		# resize ��������
		set $width "-";
		set $height "-";

		if ($arg_w != '')
		{
			set $width $arg_w;
		}
		if ($arg_h != '')
		{
			set $height $arg_h;
		}



    		location / {
		   
			proxy_pass http://wordpress;  # URL ������ ������� � �������������
			proxy_set_header Host "wp-astronews.ror.ru";

			if ($arg_q) {
				set $jpeg_quality $arg_q;
			}
			if ($arg_q = "") {
				set $jpeg_quality 85; # �������� �� ���������
			}

			image_filter_jpeg_quality $jpeg_quality;


			image_filter crop $width $height;

#			image_filter resize $arg_w $arg_h;
			image_filter_buffer 10M;


			image_filter_interlace on;

			error_page 415 = /empty;
		   

		}

	location = /empty {
		empty_gif;
	}


}


 



#wordpress headless cms

server {

	server_name   wp-astronews.ror.ru;
    listen 80;


	access_log /var/log/nginx/wp_access.log main;

	error_log  /var/log/nginx/wp_error.log;
#	access_log /var/log/nginx/wp_access.log;


	sendfile        on;
    #tcp_nopush     on;
    proxy_read_timeout 500;
    proxy_connect_timeout 500;
    proxy_send_timeout 500;
    send_timeout 500;
    keepalive_timeout  165;
	 
 
	location / {
		client_max_body_size 100M;
		proxy_redirect off;

        	proxy_set_header Host $host;

#		proxy_set_header Host $host:$server_port; # <-- this one solved mine
#		proxy_set_header Host "wp-astronews.ror.ru:443";
		proxy_set_header X-Forwarded-Host $http_host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_pass http://wordpress:80;

    }

}

#phpmyadmin phpmyadmin-astronews
server {

	server_name   phpmyadmin-astronews.ror.ru;
    listen 80;
	
	location /  {
		proxy_pass http://phpmyadmin:80;
		proxy_set_header Host $host;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Real-IP $remote_addr;
    }

}



  
}